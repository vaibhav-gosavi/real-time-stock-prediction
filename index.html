<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Prediction App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-600 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <span class="text-white text-xl font-bold">StockPredict</span>
            <div class="space-x-4">
                <button class="text-white hover:text-blue-200" onclick="showPage('dashboard')">Dashboard</button>
                <button class="text-white hover:text-blue-200" onclick="showPage('analysis')">Analysis</button>
                <button class="text-white hover:text-blue-200" onclick="showPage('historical')">Historical</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active container mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Stock Search -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Stock Search</h2>
                <!-- Form with no inline onsubmit handler -->
                <form id="predictionForm" class="flex space-x-2">
                    <input type="text" id="stockSymbol" placeholder="Enter stock symbol" class="flex-1 p-2 border rounded">
                    <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">
                        Predict
                    </button>
                </form>
            </div>

            <!-- Current Prediction -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Current Prediction</h2>
                <div class="space-y-2">
                    <p>Decision: <span id="decision" class="font-bold">-</span></p>
                    <p>Current Price: $<span id="currentPrice">-</span></p>
                    <p>Average Prediction: $<span id="avgPrediction">-</span></p>
                </div>
            </div>

            <!-- Model Predictions -->
            <div class="bg-white p-6 rounded-lg shadow col-span-2">
                <h2 class="text-xl font-bold mb-4">Model Predictions</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">ARIMA Prediction</h3>
                        <img id="arimaGraph" class="w-full h-auto" alt="ARIMA Prediction">
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">LSTM Prediction</h3>
                        <img id="lstmGraph" class="w-full h-auto" alt="LSTM Prediction">
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Linear Regression Prediction</h3>
                        <img id="lrGraph" class="w-full h-auto" alt="Linear Regression Prediction">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Page -->
    <div id="analysis" class="page container mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow col-span-2">
                <h2 class="text-xl font-bold mb-4">Performance Analysis</h2>
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Historical Page -->
    <div id="historical" class="page container mx-auto p-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4">Historical Predictions</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 border-b bg-gray-100">Date</th>
                            <th class="px-6 py-3 border-b bg-gray-100">Symbol</th>
                            <th class="px-6 py-3 border-b bg-gray-100">Prediction</th>
                            <th class="px-6 py-3 border-b bg-gray-100">Actual</th>
                            <th class="px-6 py-3 border-b bg-gray-100">Decision</th>
                        </tr>
                    </thead>
                    <tbody id="historicalData">
                        <!-- Data will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-lg m-auto">
            <h3 class="text-xl font-bold mb-4">Error</h3>
            <p id="errorMessage"></p>
            <button onclick="closeErrorModal()" 
                    class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">
                Close
            </button>
        </div>
    </div>

    <script>
        // Global chart variable
        let performanceChart = null;

        // Debugging function
        function debugLog(type, message, data = null) {
            const timestamp = new Date().toISOString();
            console.group(`${timestamp} - ${type}`);
            console.log('Message:', message);
            if (data) {
                console.log('Data:', data);
            }
            console.groupEnd();
        }

        // Initialize performance chart
        function initPerformanceChart() {
            debugLog('Chart', 'Initializing performance chart');
            try {
                const ctx = document.getElementById('performanceChart');
                if (!ctx) {
                    debugLog('Error', 'Performance chart canvas not found');
                    return;
                }

                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ARIMA', 'LSTM', 'Linear Regression'],
                        datasets: [{
                            label: 'Model Accuracy (%)',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Accuracy (%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Model Performance Comparison'
                            }
                        }
                    }
                });
                debugLog('Chart', 'Performance chart initialized successfully');
            } catch (error) {
                debugLog('Error', 'Failed to initialize performance chart', {
                    error: error.message,
                    stack: error.stack
                });
            }
        }

        // Update performance chart
        function updatePerformanceChart(accuracies) {
            debugLog('Chart Update', 'Updating performance chart', accuracies);
            
            if (!performanceChart) {
                debugLog('Error', 'Performance chart not initialized');
                return;
            }
            
            try {
                performanceChart.data.datasets[0].data = [
                    accuracies.arima * 100,
                    accuracies.lstm * 100,
                    accuracies.linear_regression * 100
                ];
                performanceChart.update();
                debugLog('Chart Update', 'Performance chart updated successfully');
            } catch (error) {
                debugLog('Error', 'Failed to update performance chart', {
                    error: error.message,
                    stack: error.stack
                });
            }
        }

        // Show/Hide Pages
        function showPage(pageId) {
            debugLog('Navigation', `Switching to page: ${pageId}`);
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const selectedPage = document.getElementById(pageId);
            if (selectedPage) {
                selectedPage.classList.add('active');
            }
        }

        // Form submission handler
        async function handleSubmit(event) {
            event.preventDefault();
            await predictStock();
        }

        // Predict Stock function
        async function predictStock() {
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            debugLog('User Input', 'Stock symbol entered', { symbol });

            if (!symbol) {
                showError('Please enter a stock symbol');
                return;
            }

            try {
                // Show loading state
                document.getElementById('decision').textContent = 'Loading...';
                document.getElementById('currentPrice').textContent = 'Loading...';
                document.getElementById('avgPrediction').textContent = 'Loading...';

                const response = await fetch('http://localhost:8000/predict/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ stock_symbol: symbol })
                });

                debugLog('API Response', 'Response received', {
                    status: response.status,
                    statusText: response.statusText
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                debugLog('API Data', 'Parsed response data', data);

                await updateUI(data, symbol);

            } catch (error) {
                debugLog('Error', 'Prediction failed', {
                    error: error.message,
                    stack: error.stack
                });
                showError(`Failed to predict stock prices: ${error.message}`);
                
                // Reset UI on error
                document.getElementById('decision').textContent = '-';
                document.getElementById('currentPrice').textContent = '-';
                document.getElementById('avgPrediction').textContent = '-';
            }
        }

        // Update UI function
        async function updateUI(data, symbol) {
            try {
                // Update text fields
                document.getElementById('decision').textContent = data.decision || '-';
                document.getElementById('currentPrice').textContent = 
                    data.current_price ? data.current_price.toFixed(2) : '-';
                document.getElementById('avgPrediction').textContent = 
                    data.average ? data.average.toFixed(2) : '-';

                // Update graphs
                const timestamp = Date.now();
                const models = ['arima', 'lstm', 'lr'];
                
                for (const model of models) {
                    const img = document.getElementById(`${model}Graph`);
                    if (img) {
                        const newImage = new Image();
                        const newSrc = `http://localhost:8000/static/${model}_stock_price_plot.png?t=${timestamp}`;
                        
                        newImage.onload = () => {
                            img.src = newSrc;
                            debugLog('Image Update', `${model} graph updated successfully`);
                        };
                        
                        newImage.onerror = () => {
                            debugLog('Image Error', `Failed to load ${model} graph`);
                            img.alt = 'Failed to load graph';
                        };
                        
                        newImage.src = newSrc;
                    }
                }

                // Add to historical data
                addToHistorical(symbol, data);

                // Update performance chart
                if (data.model_accuracies) {
                    updatePerformanceChart(data.model_accuracies);
                }

            } catch (error) {
                debugLog('Error', 'UI update failed', {
                    error: error.message,
                    stack: error.stack
                });
                showError(`Failed to update UI: ${error.message}`);
            }
        }

        // Add to historical data
        function addToHistorical(symbol, data) {
            debugLog('Historical Data', 'Adding new historical entry', { symbol, data });
            
            try {
                const table = document.getElementById('historicalData');
                if (!table) {
                    debugLog('Error', 'Historical data table not found');
                    return;
                }

                const row = table.insertRow(0);
                
                const cells = [
                    new Date().toLocaleDateString(),
                    symbol,
                    data.average.toFixed(2),
                    data.current_price.toFixed(2),
                    data.decision
                ];

                cells.forEach((text, index) => {
                    const cell = row.insertCell();
                    cell.textContent = text;
                    cell.className = 'px-6 py-4 border-b';
                });

                debugLog('Historical Data', 'Historical entry added successfully');
            } catch (error) {
                debugLog('Error', 'Failed to add historical entry', {
                    error: error.message,
                    stack: error.stack
                });
            }
        }

        // Show error modal
        function showError(message) {
            debugLog('Error Modal', 'Showing error modal', { message });
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorMessage && errorModal) {
                errorMessage.textContent = message;
                errorModal.classList.add('active');
            }
        }

        // Close error modal
        function closeErrorModal() {
            debugLog('Error Modal', 'Closing error modal');
            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                errorModal.classList.remove('active');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Initialization', 'Page loaded, starting initialization');
            
            // Initialize performance chart
            initPerformanceChart();
            
            // Show default page
            showPage('dashboard');
            
            // Set up form submission handler
            const form = document.getElementById('predictionForm');
            if (form) {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    console.log('Form submission intercepted');
                    await predictStock();
                });
            }
            
            // Set up error modal close handler
            const closeModalButton = document.getElementById('closeErrorModal');
            if (closeModalButton) {
                closeModalButton.addEventListener('click', closeErrorModal);
            }
            
            debugLog('Initialization', 'Initialization completed');
        });
    </script>
</body>
</html>
